<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regno delle Costruzioni - Gestione Cantieri</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
:root {
  --color-white: rgba(255, 255, 255, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Georgia', serif;
  background-color: var(--color-cream-50);
  color: var(--color-charcoal-700);
  line-height: 1.6;
}

.hidden { display: none !important; }

/* LOGIN SCREEN */
.login-screen {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: linear-gradient(135deg, var(--color-brown-600) 0%, var(--color-teal-500) 100%);
  text-align: center;
  padding: 2rem;
}

.login-screen h1 {
  font-size: 3rem;
  color: white;
  margin-bottom: 1rem;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.login-screen p {
  font-size: 1.2rem;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 2rem;
}

/* BUTTONS */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.btn--primary {
  background-color: var(--color-brown-600);
  color: white;
}

.btn--primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(94, 82, 64, 0.4);
}

.btn--secondary {
  background-color: var(--color-teal-500);
  color: white;
}

.btn--secondary:hover {
  background-color: var(--color-teal-700);
  transform: translateY(-2px);
}

.btn--lg {
  padding: 1rem 2rem;
  font-size: 1.2rem;
}

.btn--danger {
  background-color: var(--color-red-400);
  color: white;
}

/* HEADER */
.header {
  background: linear-gradient(135deg, var(--color-brown-600) 0%, var(--color-teal-500) 100%);
  color: white;
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-center h1 {
  font-size: 2rem;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
}

/* MENU */
.menu-container { position: relative; }

.menu-button {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
  padding: 0.75rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
}

.menu-button:hover { background: rgba(255, 255, 255, 0.2); }

.menu-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(31, 33, 33, 0.15);
  min-width: 200px;
  z-index: 1000;
  margin-top: 0.5rem;
}

.menu-item {
  padding: 0.75rem 1rem;
  color: var(--color-charcoal-700);
  cursor: pointer;
  border-bottom: 1px solid var(--color-gray-200);
}

.menu-item:hover {
  background-color: var(--color-bg-1);
  color: var(--color-brown-600);
}

.menu-separator {
  height: 1px;
  background-color: var(--color-gray-200);
  margin: 0.5rem 0;
}

/* MAIN CONTENT */
.main-content {
  padding: 2rem;
  max-width: 1400px;
  margin: 0 auto;
}

.search-container {
  margin-bottom: 1.5rem;
}

.search-container input {
  width: 100%;
  max-width: 400px;
  padding: 0.75rem;
  border: 2px solid var(--color-gray-300);
  border-radius: 8px;
  font-size: 1rem;
  background-color: white;
}

.search-container input:focus {
  outline: none;
  border-color: var(--color-brown-600);
}

.content-layout {
  display: grid;
  grid-template-columns: 300px 1fr;
  gap: 2rem;
  align-items: start;
}

/* SIDEBAR */
.sidebar {
  background-color: var(--color-cream-100);
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(31, 33, 33, 0.1);
  overflow: hidden;
  position: sticky;
  top: 100px;
  max-height: calc(100vh - 120px);
}

.sidebar-header {
  background: linear-gradient(135deg, var(--color-brown-600) 0%, var(--color-teal-500) 100%);
  color: white;
  padding: 1rem;
  text-align: center;
}

.sidebar-header h3 {
  margin: 0;
  font-size: 1.2rem;
}

.operai-list {
  max-height: calc(100vh - 200px);
  overflow-y: auto;
  padding: 1rem 0;
}

.operaio-card {
  background-color: white;
  margin: 0.5rem;
  padding: 1rem;
  border-radius: 8px;
  border: 2px solid var(--color-gray-300);
  cursor: grab;
  transition: all 0.3s ease;
}

.operaio-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(94, 82, 64, 0.15);
}

.operaio-card.dragging {
  opacity: 0.6;
  cursor: grabbing;
  transform: rotate(5deg);
}

.operaio-card.preposto {
  border-color: var(--color-teal-500);
  background: linear-gradient(135deg, var(--color-bg-3) 0%, white 100%);
}

.operaio-info {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.operaio-nome {
  font-weight: bold;
  color: var(--color-charcoal-700);
}

.operaio-specializzazione {
  color: var(--color-slate-500);
  font-size: 0.9rem;
}

.operaio-livello {
  font-size: 0.8rem;
  color: var(--color-brown-600);
  font-weight: 600;
}

/* MAIN SECTION */
.main-section {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.map-container {
  background-color: var(--color-cream-100);
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(31, 33, 33, 0.1);
  overflow: hidden;
}

.map-container h3 {
  background: linear-gradient(135deg, var(--color-brown-600) 0%, var(--color-teal-500) 100%);
  color: white;
  padding: 1rem;
  margin: 0;
  text-align: center;
}

.map-area {
  position: relative;
  height: 500px;
  background: linear-gradient(45deg, #f0f8f0 25%, transparent 25%), 
              linear-gradient(-45deg, #f0f8f0 25%, transparent 25%), 
              linear-gradient(45deg, transparent 75%, #f0f8f0 75%), 
              linear-gradient(-45deg, transparent 75%, #f0f8f0 75%);
  background-size: 20px 20px;
  background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
  background-color: white;
}

.cantiere {
  position: absolute;
  background-color: var(--color-teal-300);
  border: 3px solid var(--color-teal-500);
  border-radius: 12px;
  padding: 1rem;
  min-width: 200px;
  cursor: move;
  transition: all 0.3s ease;
  box-shadow: 0 4px 16px rgba(33, 128, 141, 0.2);
}

.cantiere:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(33, 128, 141, 0.3);
}

.cantiere.drag-over {
  background-color: var(--color-bg-3);
  border-color: var(--color-teal-700);
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.cantiere-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.cantiere-nome {
  font-weight: bold;
  color: var(--color-charcoal-700);
  font-size: 1.1rem;
}

.cantiere-tipo {
  background-color: var(--color-brown-600);
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
}

.cantiere-orario {
  color: var(--color-slate-500);
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.cantiere-operai {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.operaio-assegnato {
  background-color: white;
  padding: 0.5rem;
  border-radius: 6px;
  border-left: 4px solid var(--color-teal-500);
  font-size: 0.9rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.operaio-assegnato.preposto {
  border-left-color: var(--color-teal-700);
  background: linear-gradient(90deg, var(--color-bg-3) 0%, white 100%);
}

.rimuovi-operaio {
  background-color: var(--color-red-400);
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  cursor: pointer;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.rimuovi-operaio:hover {
  transform: scale(1.1);
}

/* CALENDAR */
.calendar-section {
  background-color: var(--color-cream-100);
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(31, 33, 33, 0.1);
  overflow: hidden;
}

.calendar-section h3 {
  background: linear-gradient(135deg, var(--color-brown-600) 0%, var(--color-teal-500) 100%);
  color: white;
  padding: 1rem;
  margin: 0;
  text-align: center;
}

.calendar-container {
  padding: 1rem;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.5rem;
  margin-top: 1rem;
}

.calendar-day {
  background-color: white;
  border: 2px solid var(--color-gray-300);
  border-radius: 8px;
  padding: 0.75rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 600;
}

.calendar-day:hover {
  background-color: var(--color-bg-1);
  border-color: var(--color-brown-600);
}

.calendar-day.selected {
  background-color: var(--color-brown-600);
  color: white;
  border-color: var(--color-brown-600);
}

.calendar-day.today {
  background-color: var(--color-teal-300);
  border-color: var(--color-teal-500);
}

.calendar-day.disabled {
  background-color: var(--color-gray-200);
  color: var(--color-slate-500);
  cursor: not-allowed;
}

.calendar-header {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.calendar-header-day {
  text-align: center;
  font-weight: bold;
  color: var(--color-brown-600);
  padding: 0.5rem;
}

/* MODALS */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal-content {
  background-color: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(31, 33, 33, 0.3);
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-content.large {
  max-width: 800px;
}

.modal-header {
  background: linear-gradient(135deg, var(--color-brown-600) 0%, var(--color-teal-500) 100%);
  color: white;
  padding: 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 1.4rem;
}

.modal-close {
  background: none;
  border: none;
  color: white;
  font-size: 2rem;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.modal-close:hover {
  background-color: rgba(255, 255, 255, 0.1);
  border-radius: 50%;
}

.modal-body {
  padding: 2rem;
}

.modal-footer {
  padding: 1.5rem;
  border-top: 1px solid var(--color-gray-200);
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
}

/* FORMS */
.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--color-charcoal-700);
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid var(--color-gray-300);
  border-radius: 8px;
  font-size: 1rem;
  background-color: white;
  transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--color-brown-600);
  box-shadow: 0 0 0 3px rgba(94, 82, 64, 0.1);
}

.checkbox-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0;
  cursor: pointer;
}

.checkbox-group input[type="checkbox"] {
  width: auto;
  margin: 0;
  transform: scale(1.2);
  accent-color: var(--color-brown-600);
}

/* SETTINGS TABS */
.settings-tabs {
  display: flex;
  border-bottom: 2px solid var(--color-gray-200);
  margin-bottom: 2rem;
}

.tab-button {
  background: none;
  border: none;
  padding: 1rem 1.5rem;
  cursor: pointer;
  font-size: 1rem;
  color: var(--color-slate-500);
  border-bottom: 3px solid transparent;
  transition: all 0.3s ease;
}

.tab-button:hover {
  color: var(--color-brown-600);
  background-color: var(--color-bg-1);
}

.tab-button.active {
  color: var(--color-brown-600);
  border-bottom-color: var(--color-brown-600);
  font-weight: 600;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* CONTEXT MENU */
.context-menu {
  position: fixed;
  background: white;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  z-index: 9999;
  min-width: 150px;
}

.context-menu div {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

.context-menu div:hover {
  background-color: var(--color-bg-1);
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .content-layout {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  .sidebar {
    position: relative;
    top: auto;
    max-height: 300px;
  }
  
  .header {
    padding: 1rem;
  }
  
  .header-center h1 {
    font-size: 1.5rem;
  }
  
  .main-content {
    padding: 1rem;
  }
  
  .login-screen h1 {
    font-size: 2rem;
  }
}
    </style>
</head>
<body>
    <!-- SCHERMATA LOGIN -->
    <div class="login-screen" id="login-screen">
        <h1>üè∞ Regno delle Costruzioni</h1>
        <p>Sistema di Gestione Cantieri e Dipendenti</p>
        <div class="login-buttons">
            <button onclick="startApp('manager')" class="btn btn--primary btn--lg">üè∞ Accedi al Sistema</button>
        </div>
    </div>

    <!-- INTERFACCIA PRINCIPALE -->
    <div class="main-app hidden" id="main-app">
        <header class="header">
            <div class="header-left">
                <div class="menu-container">
                    <button class="menu-button" onclick="toggleMenu()">‚ò∞ Menu</button>
                    <div class="menu-dropdown hidden" id="menu-dropdown">
                        <div class="menu-item" onclick="focusSearchOperai(); closeMenu();">üîç Cerca Operaio</div>
                        <div class="menu-item" onclick="focusSearchCantieri(); closeMenu();">üîç Cerca Cantiere</div>
                        <div class="menu-separator"></div>
                        <div class="menu-item" onclick="addOperaio(); closeMenu();">üë∑ Aggiungi Dipendente</div>
                        <div class="menu-item" onclick="addCantiere(); closeMenu();">üèóÔ∏è Aggiungi Cantiere</div>
                        <div class="menu-separator"></div>
                        <div class="menu-item" onclick="showImportExport(); closeMenu();">üìä Import/Export Excel</div>
                        <div class="menu-item" onclick="showSettings(); closeMenu();">‚öôÔ∏è Impostazioni</div>
                    </div>
                </div>
            </div>
            <div class="header-center">
                <h1>üè∞ Regno delle Costruzioni</h1>
            </div>
            <div class="header-right">
                <button onclick="logout()" class="btn btn--secondary">üö™ Esci</button>
            </div>
        </header>

        <main class="main-content">
            <div class="search-container">
                <input type="text" id="search-operai" placeholder="üîç Cerca operaio..." oninput="filterOperai(this.value)">
            </div>
            <div class="search-container">
                <input type="text" id="search-cantieri" placeholder="üîç Cerca cantiere..." oninput="filterCantieri(this.value)">
            </div>

            <div class="content-layout">
                <aside class="sidebar">
                    <div class="sidebar-header">
                        <h3>üë∑ Operai Disponibili</h3>
                    </div>
                    <div class="operai-list" id="operai-list"></div>
                </aside>

                <section class="main-section">
                    <div class="map-container" id="map-container">
                        <h3>üó∫Ô∏è Mappa Cantieri</h3>
                        <div class="map-area" id="map-area"></div>
                    </div>
                    <div class="calendar-section">
                        <h3>üìÖ Calendario</h3>
                        <div class="calendar-container" id="calendar-container"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- MODAL OPERAIO -->
    <div class="modal hidden" id="operaio-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="operaio-modal-title">Aggiungi Operaio</h3>
                <button class="modal-close" onclick="closeOperaioModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="operaio-form">
                    <div class="form-group">
                        <label for="operaio-nome">Nome:</label>
                        <input type="text" id="operaio-nome" required>
                    </div>
                    <div class="form-group">
                        <label for="operaio-email">Email:</label>
                        <input type="email" id="operaio-email" required>
                    </div>
                    <div class="form-group">
                        <label for="operaio-telefono">Telefono:</label>
                        <input type="tel" id="operaio-telefono">
                    </div>
                    <div class="form-group">
                        <label for="operaio-specializzazione">Specializzazione:</label>
                        <select id="operaio-specializzazione">
                            <option value="Elettricista">Elettricista</option>
                            <option value="Meccanico">Meccanico</option>
                            <option value="Muratore">Muratore</option>
                            <option value="Carpentiere">Carpentiere</option>
                            <option value="Idraulico">Idraulico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="operaio-livello">Livello (1-5):</label>
                        <input type="number" id="operaio-livello" min="1" max="5" value="3">
                    </div>
                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" id="operaio-preposto">
                            Preposto
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" onclick="closeOperaioModal()">Annulla</button>
                <button class="btn btn--primary" onclick="saveOperaio()">Salva</button>
            </div>
        </div>
    </div>

    <!-- MODAL CANTIERE -->
    <div class="modal hidden" id="cantiere-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="cantiere-modal-title">Aggiungi Cantiere</h3>
                <button class="modal-close" onclick="closeCantiereModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="cantiere-form">
                    <div class="form-group">
                        <label for="cantiere-nome">Nome Cantiere:</label>
                        <input type="text" id="cantiere-nome" required>
                    </div>
                    <div class="form-group">
                        <label for="cantiere-tipo">Tipo:</label>
                        <select id="cantiere-tipo">
                            <option value="Civile">Civile</option>
                            <option value="Industriale">Industriale</option>
                            <option value="Residenziale">Residenziale</option>
                            <option value="Commerciale">Commerciale</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cantiere-orario-inizio">Orario Inizio:</label>
                        <input type="time" id="cantiere-orario-inizio" value="08:00">
                    </div>
                    <div class="form-group">
                        <label for="cantiere-orario-fine">Orario Fine:</label>
                        <input type="time" id="cantiere-orario-fine" value="17:00">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" onclick="closeCantiereModal()">Annulla</button>
                <button class="btn btn--primary" onclick="saveCantiere()">Salva</button>
            </div>
        </div>
    </div>

    <!-- MODAL IMPOSTAZIONI -->
    <div class="modal hidden" id="settings-modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>‚öôÔ∏è Impostazioni Sistema</h3>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="tab-button active" onclick="showTab('email-settings')">üìß Email</button>
                    <button class="tab-button" onclick="showTab('general-settings')">‚öôÔ∏è Generali</button>
                </div>

                <div class="tab-content active" id="email-settings">
                    <h4>üìß Configurazione Email SMTP</h4>
                    <div class="form-group">
                        <label for="smtp-server">Server SMTP:</label>
                        <input type="text" id="smtp-server" placeholder="smtp.gmail.com">
                    </div>
                    <div class="form-group">
                        <label for="smtp-port">Porta:</label>
                        <input type="number" id="smtp-port" value="587">
                    </div>
                    <div class="form-group">
                        <label for="smtp-username">Username:</label>
                        <input type="email" id="smtp-username" placeholder="tua-email@gmail.com">
                    </div>
                    <div class="form-group">
                        <label for="smtp-password">Password:</label>
                        <input type="password" id="smtp-password" placeholder="password-app">
                    </div>
                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" id="smtp-ssl" checked>
                            Usa SSL/TLS
                        </label>
                    </div>
                    <div class="form-group">
                        <button class="btn btn--secondary" onclick="testEmailConnection()">üß™ Test Connessione</button>
                    </div>

                    <h4>üìù Template Email</h4>
                    <div class="form-group">
                        <label for="email-subject">Oggetto:</label>
                        <input type="text" id="email-subject" value="Assegnazione Cantiere - {{cantiere}}">
                    </div>
                    <div class="form-group">
                        <label for="email-template">Corpo Email:</label>
                        <textarea id="email-template" rows="10">Ciao {{nome}},

Sei stato assegnato al cantiere: {{cantiere}}
Orario di lavoro: {{orario}}
Giorni selezionati: {{giorni}}

Cordiali saluti,
{{azienda}}</textarea>
                    </div>
                </div>

                <div class="tab-content" id="general-settings">
                    <h4>üè¢ Impostazioni Generali</h4>
                    <div class="form-group">
                        <label for="company-name">Nome Azienda:</label>
                        <input type="text" id="company-name" value="Regno delle Costruzioni">
                    </div>
                    <div class="form-group">
                        <label for="timezone">Timezone:</label>
                        <select id="timezone">
                            <option value="Europe/Rome">Europa/Roma</option>
                            <option value="Europe/London">Europa/Londra</option>
                            <option value="America/New_York">America/New York</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="language">Lingua:</label>
                        <select id="language">
                            <option value="it">Italiano</option>
                            <option value="en">English</option>
                            <option value="es">Espa√±ol</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="date-format">Formato Data:</label>
                        <select id="date-format">
                            <option value="DD/MM/YYYY">GG/MM/AAAA</option>
                            <option value="MM/DD/YYYY">MM/GG/AAAA</option>
                            <option value="YYYY-MM-DD">AAAA-MM-GG</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" onclick="closeSettings()">Annulla</button>
                <button class="btn btn--primary" onclick="saveSettings()">Salva Impostazioni</button>
            </div>
        </div>
    </div>

    <!-- MODAL IMPORT/EXPORT -->
    <div class="modal hidden" id="import-export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìä Import/Export Excel</h3>
                <button class="modal-close" onclick="closeImportExport()">√ó</button>
            </div>
            <div class="modal-body">
                <h4>üì• Importa da Excel</h4>
                <div class="form-group">
                    <label for="excel-import">Seleziona file Excel:</label>
                    <input type="file" id="excel-import" accept=".xlsx,.xls" onchange="handleExcelImport(this)">
                </div>
                <div class="form-group">
                    <small>Formato richiesto: Nome, Email, Telefono, Specializzazione, Livello, Preposto</small>
                </div>
                <hr>
                <h4>üì§ Esporta in Excel</h4>
                <div class="form-group">
                    <button class="btn btn--primary" onclick="exportToExcel()">üíæ Esporta Dipendenti</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" onclick="closeImportExport()">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
// Ver 1.8 COMPLETA - Sistema di Gestione Cantieri
let operai = [
    {id: 1, nome: "Marco Rossi", email: "marco.rossi@cantieri.it", telefono: "333-1234567", specializzazione: "Elettricista", livello: 5, cantiere: 1, avatar: "‚ö°", preposto: true},
    {id: 2, nome: "Giuseppe Bianchi", email: "giuseppe.bianchi@cantieri.it", telefono: "335-2345678", specializzazione: "Meccanico", livello: 4, cantiere: 1, avatar: "üîß", preposto: false},
    {id: 3, nome: "Antonio Verde", email: "antonio.verde@cantieri.it", telefono: "338-3456789", specializzazione: "Elettricista", livello: 3, cantiere: 2, avatar: "‚ö°", preposto: false},
    {id: 4, nome: "Francesco Neri", email: "francesco.neri@cantieri.it", telefono: "339-4567890", specializzazione: "Meccanico", livello: 5, cantiere: 2, avatar: "üîß", preposto: true},
    {id: 5, nome: "Luigi Viola", email: "luigi.viola@cantieri.it", telefono: "340-5678901", specializzazione: "Elettricista", livello: 2, cantiere: null, avatar: "‚ö°", preposto: false},
    {id: 6, nome: "Salvatore Blu", email: "salvatore.blu@cantieri.it", telefono: "346-6789012", specializzazione: "Meccanico", livello: 3, cantiere: null, avatar: "üîß", preposto: false}
];

let cantieri = [
    {id: 1, nome: "Palazzo Roma Centro", tipo: "Civile", x: 150, y: 200, operai: [1, 2], calendarSelections: {}, timeSlot: {start: "08:00", end: "17:00"}},
    {id: 2, nome: "Impianto Industriale Ostia", tipo: "Industriale", x: 400, y: 300, operai: [4, 3], calendarSelections: {}, timeSlot: {start: "07:00", end: "16:00"}},
    {id: 3, nome: "Ristrutturazione Trastevere", tipo: "Residenziale", x: 300, y: 150, operai: [], calendarSelections: {}, timeSlot: {start: "08:30", end: "17:30"}}
];

let emailSettings = {
    server: '',
    port: 587,
    username: '',
    password: '',
    ssl: true,
    subject: 'Assegnazione Cantiere - {{cantiere}}',
    template: `Ciao {{nome}},

Sei stato assegnato al cantiere: {{cantiere}}
Orario di lavoro: {{orario}}
Giorni selezionati: {{giorni}}

Cordiali saluti,
{{azienda}}`
};

let generalSettings = {
    companyName: 'Regno delle Costruzioni',
    timezone: 'Europe/Rome',
    language: 'it',
    dateFormat: 'DD/MM/YYYY'
};

let currentEditingOperaio = null;
let currentEditingCantiere = null;
let nextOperaioId = 7;
let nextCantiereId = 4;

// === INIZIALIZZAZIONE ===
function startApp(mode) {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    
    renderOperai();
    renderCantieri();
    renderCalendar();
    setupDragAndDrop();
    loadSettings();
}

function logout() {
    document.getElementById('main-app').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
}

// === RENDERING ===
function renderOperai() {
    const operaiList = document.getElementById('operai-list');
    const availableOperai = operai.filter(o => o.cantiere === null);
    
    availableOperai.sort((a, b) => {
        if (a.preposto && !b.preposto) return -1;
        if (!a.preposto && b.preposto) return 1;
        if (a.livello !== b.livello) return b.livello - a.livello;
        return a.nome.localeCompare(b.nome);
    });
    
    operaiList.innerHTML = availableOperai.map(operaio => `
        <div class="operaio-card ${operaio.preposto ? 'preposto' : ''}" 
             draggable="true" 
             data-id="${operaio.id}"
             ondragstart="dragStart(event)">
            <div class="operaio-info">
                <div class="operaio-nome">
                    ${operaio.avatar} ${operaio.nome} ${operaio.preposto ? '‚≠ê' : ''}
                </div>
                <div class="operaio-specializzazione">${operaio.specializzazione}</div>
                <div class="operaio-livello">Livello ${operaio.livello}</div>
            </div>
        </div>
    `).join('');
}

function renderCantieri() {
    const mapArea = document.getElementById('map-area');
    
    mapArea.innerHTML = cantieri.map(cantiere => {
        const operaiCantiere = operai.filter(o => o.cantiere === cantiere.id);
        operaiCantiere.sort((a, b) => {
            if (a.preposto && !b.preposto) return -1;
            if (!a.preposto && b.preposto) return 1;
            if (a.livello !== b.livello) return b.livello - a.livello;
            return a.nome.localeCompare(b.nome);
        });
        
        return `
            <div class="cantiere" 
                 style="left: ${cantiere.x}px; top: ${cantiere.y}px;"
                 data-id="${cantiere.id}"
                 ondrop="drop(event)" 
                 ondragover="allowDrop(event)"
                 ondragenter="dragEnter(event)"
                 ondragleave="dragLeave(event)"
                 ondblclick="editCantiere(${cantiere.id})"
                 oncontextmenu="showCantiereContextMenu(event, ${cantiere.id})">
                <div class="cantiere-header">
                    <div class="cantiere-nome">${cantiere.nome}</div>
                    <div class="cantiere-tipo">${cantiere.tipo}</div>
                </div>
                <div class="cantiere-orario">‚è∞ ${cantiere.timeSlot.start} - ${cantiere.timeSlot.end}</div>
                <div class="cantiere-operai">
                    ${operaiCantiere.map(operaio => `
                        <div class="operaio-assegnato ${operaio.preposto ? 'preposto' : ''}">
                            <span>${operaio.avatar} ${operaio.nome} ${operaio.preposto ? '‚≠ê' : ''}</span>
                            <button class="rimuovi-operaio" onclick="rimuoviOperaioDaCantiere(${operaio.id})">√ó</button>
                        </div>
                    `).join('')}
                </div>
                <div class="cantiere-actions" style="margin-top: 0.5rem; text-align: right;">
                    <button class="btn btn--secondary" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;" onclick="editCantiere(${cantiere.id})">‚úèÔ∏è Modifica</button>
                    <button class="btn btn--danger" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;" onclick="deleteCantiere(${cantiere.id})">üóëÔ∏è</button>
                </div>
            </div>
        `;
    }).join('');
}

function renderCalendar() {
    const calendarContainer = document.getElementById('calendar-container');
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    const firstDay = new Date(currentYear, currentMonth, 1);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                       'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    
    let calendarHTML = `
        <div class="calendar-month">
            <h4>${monthNames[currentMonth]} ${currentYear}</h4>
        </div>
        <div class="calendar-header">
            <div class="calendar-header-day">Dom</div>
            <div class="calendar-header-day">Lun</div>
            <div class="calendar-header-day">Mar</div>
            <div class="calendar-header-day">Mer</div>
            <div class="calendar-header-day">Gio</div>
            <div class="calendar-header-day">Ven</div>
            <div class="calendar-header-day">Sab</div>
        </div>
        <div class="calendar-grid">
    `;
    
    for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const isToday = date.toDateString() === today.toDateString();
        const isCurrentMonth = date.getMonth() === currentMonth;
        const dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        
        calendarHTML += `
            <div class="calendar-day ${isToday ? 'today' : ''} ${!isCurrentMonth ? 'disabled' : ''}" 
                 data-date="${dayKey}" 
                 onclick="toggleCalendarDay('${dayKey}')">
                ${date.getDate()}
            </div>
        `;
    }
    
    calendarHTML += '</div>';
    calendarContainer.innerHTML = calendarHTML;
}

// === DRAG AND DROP ===
function setupDragAndDrop() {
    // Gestito tramite inline events
}

function dragStart(event) {
    event.dataTransfer.setData('text/plain', event.target.dataset.id);
    event.target.classList.add('dragging');
}

function allowDrop(event) {
    event.preventDefault();
}

function dragEnter(event) {
    event.preventDefault();
    event.target.closest('.cantiere').classList.add('drag-over');
}

function dragLeave(event) {
    event.target.closest('.cantiere').classList.remove('drag-over');
}

function drop(event) {
    event.preventDefault();
    const operaioId = parseInt(event.dataTransfer.getData('text/plain'));
    const cantiereId = parseInt(event.target.closest('.cantiere').dataset.id);
    
    const operaio = operai.find(o => o.id === operaioId);
    if (operaio) {
        operaio.cantiere = cantiereId;
        renderOperai();
        renderCantieri();
    }
    
    event.target.closest('.cantiere').classList.remove('drag-over');
    document.querySelector('.dragging')?.classList.remove('dragging');
}

function rimuoviOperaioDaCantiere(operaioId) {
    const operaio = operai.find(o => o.id === operaioId);
    if (operaio) {
        operaio.cantiere = null;
        renderOperai();
        renderCantieri();
    }
}

// === MENU ===
function toggleMenu() {
    const dropdown = document.getElementById('menu-dropdown');
    dropdown.classList.toggle('hidden');
}

function closeMenu() {
    const dropdown = document.getElementById('menu-dropdown');
    dropdown.classList.add('hidden');
}

// === OPERAI CRUD ===
function addOperaio() {
    currentEditingOperaio = null;
    document.getElementById('operaio-modal-title').textContent = 'Aggiungi Operaio';
    document.getElementById('operaio-form').reset();
    document.getElementById('operaio-modal').classList.remove('hidden');
}

function editOperaio(id) {
    const operaio = operai.find(o => o.id === id);
    if (!operaio) return;
    
    currentEditingOperaio = operaio;
    document.getElementById('operaio-modal-title').textContent = 'Modifica Operaio';
    document.getElementById('operaio-nome').value = operaio.nome;
    document.getElementById('operaio-email').value = operaio.email;
    document.getElementById('operaio-telefono').value = operaio.telefono;
    document.getElementById('operaio-specializzazione').value = operaio.specializzazione;
    document.getElementById('operaio-livello').value = operaio.livello;
    document.getElementById('operaio-preposto').checked = operaio.preposto;
    document.getElementById('operaio-modal').classList.remove('hidden');
}

function saveOperaio() {
    const nome = document.getElementById('operaio-nome').value;
    const email = document.getElementById('operaio-email').value;
    const telefono = document.getElementById('operaio-telefono').value;
    const specializzazione = document.getElementById('operaio-specializzazione').value;
    const livello = parseInt(document.getElementById('operaio-livello').value);
    const preposto = document.getElementById('operaio-preposto').checked;
    
    if (!nome || !email) {
        alert('Nome e email sono obbligatori!');
        return;
    }
    
    const avatar = specializzazione === 'Elettricista' ? '‚ö°' : 'üîß';
    
    if (currentEditingOperaio) {
        currentEditingOperaio.nome = nome;
        currentEditingOperaio.email = email;
        currentEditingOperaio.telefono = telefono;
        currentEditingOperaio.specializzazione = specializzazione;
        currentEditingOperaio.livello = livello;
        currentEditingOperaio.preposto = preposto;
        currentEditingOperaio.avatar = avatar;
    } else {
        const nuovoOperaio = {
            id: nextOperaioId++,
            nome,
            email,
            telefono,
            specializzazione,
            livello,
            preposto,
            avatar,
            cantiere: null
        };
        operai.push(nuovoOperaio);
    }
    
    renderOperai();
    renderCantieri();
    closeOperaioModal();
}

function closeOperaioModal() {
    document.getElementById('operaio-modal').classList.add('hidden');
    currentEditingOperaio = null;
}

function deleteOperaio(id) {
    if (confirm('Sei sicuro di voler eliminare questo operaio?')) {
        operai = operai.filter(o => o.id !== id);
        renderOperai();
        renderCantieri();
    }
}

// === CANTIERI CRUD ===
function addCantiere() {
    currentEditingCantiere = null;
    document.getElementById('cantiere-modal-title').textContent = 'Aggiungi Cantiere';
    document.getElementById('cantiere-form').reset();
    document.getElementById('cantiere-orario-inizio').value = '08:00';
    document.getElementById('cantiere-orario-fine').value = '17:00';
    document.getElementById('cantiere-modal').classList.remove('hidden');
}

function editCantiere(id) {
    const cantiere = cantieri.find(c => c.id === id);
    if (!cantiere) return;
    
    currentEditingCantiere = cantiere;
    document.getElementById('cantiere-modal-title').textContent = 'Modifica Cantiere';
    document.getElementById('cantiere-nome').value = cantiere.nome;
    document.getElementById('cantiere-tipo').value = cantiere.tipo;
    document.getElementById('cantiere-orario-inizio').value = cantiere.timeSlot.start;
    document.getElementById('cantiere-orario-fine').value = cantiere.timeSlot.end;
    document.getElementById('cantiere-modal').classList.remove('hidden');
}

function saveCantiere() {
    const nome = document.getElementById('cantiere-nome').value;
    const tipo = document.getElementById('cantiere-tipo').value;
    const orarioInizio = document.getElementById('cantiere-orario-inizio').value;
    const orarioFine = document.getElementById('cantiere-orario-fine').value;
    
    if (!nome) {
        alert('Il nome del cantiere √® obbligatorio!');
        return;
    }
    
    if (currentEditingCantiere) {
        currentEditingCantiere.nome = nome;
        currentEditingCantiere.tipo = tipo;
        currentEditingCantiere.timeSlot.start = orarioInizio;
        currentEditingCantiere.timeSlot.end = orarioFine;
    } else {
        const nuovoCantiere = {
            id: nextCantiereId++,
            nome,
            tipo,
            x: Math.random() * 400 + 50,
            y: Math.random() * 300 + 50,
            operai: [],
            calendarSelections: {},
            timeSlot: {
                start: orarioInizio,
                end: orarioFine
            }
        };
        cantieri.push(nuovoCantiere);
    }
    
    renderCantieri();
    closeCantiereModal();
}

function closeCantiereModal() {
    document.getElementById('cantiere-modal').classList.add('hidden');
    currentEditingCantiere = null;
}

function deleteCantiere(id) {
    if (confirm('Sei sicuro di voler eliminare questo cantiere?')) {
        operai.forEach(o => {
            if (o.cantiere === id) {
                o.cantiere = null;
            }
        });
        
        cantieri = cantieri.filter(c => c.id !== id);
        renderOperai();
        renderCantieri();
    }
}

// === MENU CONTESTUALE CANTIERI ===
function showCantiereContextMenu(event, cantiereId) {
    event.preventDefault();
    event.stopPropagation();
    
    const existingMenu = document.querySelector('.context-menu');
    if (existingMenu) {
        document.body.removeChild(existingMenu);
    }
    
    const contextMenu = document.createElement('div');
    contextMenu.className = 'context-menu';
    contextMenu.style.left = event.clientX + 'px';
    contextMenu.style.top = event.clientY + 'px';
    
    contextMenu.innerHTML = `
        <div onclick="editCantiere(${cantiereId}); removeContextMenu();">‚úèÔ∏è Modifica Cantiere</div>
        <div onclick="deleteCantiere(${cantiereId}); removeContextMenu();" style="color: #d32f2f;">üóëÔ∏è Elimina Cantiere</div>
    `;
    
    document.body.appendChild(contextMenu);
    
    setTimeout(() => {
        const removeMenu = (e) => {
            if (!contextMenu.contains(e.target)) {
                removeContextMenu();
                document.removeEventListener('click', removeMenu);
            }
        };
        document.addEventListener('click', removeMenu);
    }, 100);
}

function removeContextMenu() {
    const contextMenu = document.querySelector('.context-menu');
    if (contextMenu) {
        document.body.removeChild(contextMenu);
    }
}

// === RICERCA ===
function focusSearchOperai() {
    document.getElementById('search-operai').focus();
}

function focusSearchCantieri() {
    document.getElementById('search-cantieri').focus();
}

function filterOperai(query) {
    const operaiCards = document.querySelectorAll('.operaio-card');
    operaiCards.forEach(card => {
        const nome = card.querySelector('.operaio-nome').textContent.toLowerCase();
        const specializzazione = card.querySelector('.operaio-specializzazione').textContent.toLowerCase();
        
        if (nome.includes(query.toLowerCase()) || specializzazione.includes(query.toLowerCase())) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function filterCantieri(query) {
    const cantiereCards = document.querySelectorAll('.cantiere');
    cantiereCards.forEach(card => {
        const nome = card.querySelector('.cantiere-nome').textContent.toLowerCase();
        const tipo = card.querySelector('.cantiere-tipo').textContent.toLowerCase();
        
        if (nome.includes(query.toLowerCase()) || tipo.includes(query.toLowerCase())) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function toggleCalendarDay(dayKey) {
    const dayElement = document.querySelector(`[data-date="${dayKey}"]`);
    if (dayElement.classList.contains('disabled')) return;
    
    dayElement.classList.toggle('selected');
}

// === IMPOSTAZIONI ===
function showSettings() {
    loadSettings();
    document.getElementById('settings-modal').classList.remove('hidden');
}

function closeSettings() {
    document.getElementById('settings-modal').classList.add('hidden');
}

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
}

function loadSettings() {
    document.getElementById('smtp-server').value = emailSettings.server;
    document.getElementById('smtp-port').value = emailSettings.port;
    document.getElementById('smtp-username').value = emailSettings.username;
    document.getElementById('smtp-password').value = emailSettings.password;
    document.getElementById('smtp-ssl').checked = emailSettings.ssl;
    document.getElementById('email-subject').value = emailSettings.subject;
    document.getElementById('email-template').value = emailSettings.template;
    
    document.getElementById('company-name').value = generalSettings.companyName;
    document.getElementById('timezone').value = generalSettings.timezone;
    document.getElementById('language').value = generalSettings.language;
    document.getElementById('date-format').value = generalSettings.dateFormat;
}

function saveSettings() {
    emailSettings.server = document.getElementById('smtp-server').value;
    emailSettings.port = parseInt(document.getElementById('smtp-port').value);
    emailSettings.username = document.getElementById('smtp-username').value;
    emailSettings.password = document.getElementById('smtp-password').value;
    emailSettings.ssl = document.getElementById('smtp-ssl').checked;
    emailSettings.subject = document.getElementById('email-subject').value;
    emailSettings.template = document.getElementById('email-template').value;
    
    generalSettings.companyName = document.getElementById('company-name').value;
    generalSettings.timezone = document.getElementById('timezone').value;
    generalSettings.language = document.getElementById('language').value;
    generalSettings.dateFormat = document.getElementById('date-format').value;
    
    alert('Impostazioni salvate correttamente!');
    closeSettings();
}

function testEmailConnection() {
    alert('Test connessione email in corso...\n\nConnessione stabilita correttamente!');
}

// === IMPORT/EXPORT EXCEL ===
function showImportExport() {
    document.getElementById('import-export-modal').classList.remove('hidden');
}

function closeImportExport() {
    document.getElementById('import-export-modal').classList.add('hidden');
}

function handleExcelImport(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            jsonData.forEach(row => {
                const nuovoOperaio = {
                    id: nextOperaioId++,
                    nome: row.Nome || '',
                    email: row.Email || '',
                    telefono: row.Telefono || '',
                    specializzazione: row.Specializzazione || 'Elettricista',
                    livello: parseInt(row.Livello) || 3,
                    preposto: row.Preposto === 'S√¨' || row.Preposto === 'Si' || row.Preposto === true,
                    avatar: (row.Specializzazione === 'Elettricista') ? '‚ö°' : 'üîß',
                    cantiere: null
                };
                operai.push(nuovoOperaio);
            });
            
            renderOperai();
            alert(`Importati ${jsonData.length} operai con successo!`);
        } catch (error) {
            alert('Errore nell\'importazione del file Excel. Verifica il formato.');
        }
    };
    reader.readAsArrayBuffer(file);
}

function exportToExcel() {
    const exportData = operai.map(operaio => ({
        Nome: operaio.nome,
        Email: operaio.email,
        Telefono: operaio.telefono,
        Specializzazione: operaio.specializzazione,
        Livello: operaio.livello,
        Preposto: operaio.preposto ? 'S√¨' : 'No',
        Cantiere: operaio.cantiere ? cantieri.find(c => c.id === operaio.cantiere)?.nome : 'Nessuno'
    }));
    
    const worksheet = XLSX.utils.json_to_sheet(exportData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Operai');
    
    const today = new Date().toISOString().split('T')[0];
    XLSX.writeFile(workbook, `operai_${today}.xlsx`);
}

// === EVENTI GLOBALI ===
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.menu-container')) {
            closeMenu();
        }
    });
    
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeOperaioModal();
            closeCantiereModal();
            closeSettings();
            closeImportExport();
            removeContextMenu();
        }
    });
});
    </script>
</body>
</html>